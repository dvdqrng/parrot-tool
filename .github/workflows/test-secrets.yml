name: Test Secrets

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest
    steps:
      - name: Test Apple credentials
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "Testing Apple credentials..."
          echo "APPLE_ID set: $([ -n \"$APPLE_ID\" ] && echo 'yes' || echo 'no')"
          echo "APPLE_APP_SPECIFIC_PASSWORD set: $([ -n \"$APPLE_APP_SPECIFIC_PASSWORD\" ] && echo 'yes' || echo 'no')"
          echo "APPLE_TEAM_ID: $APPLE_TEAM_ID"

          # Test notarytool authentication
          echo "Testing notarytool credentials..."
          xcrun notarytool store-credentials "test-profile" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" 2>&1 && echo "✅ Credentials valid!" || echo "❌ Credentials invalid!"

      - name: Test certificate
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          echo "Testing certificate..."
          echo "CSC_LINK set: $([ -n \"$CSC_LINK\" ] && echo 'yes' || echo 'no')"
          echo "CSC_KEY_PASSWORD set: $([ -n \"$CSC_KEY_PASSWORD\" ] && echo 'yes' || echo 'no')"

          if [ -n "$CSC_LINK" ]; then
            echo "$CSC_LINK" | base64 --decode > /tmp/cert.p12
            security import /tmp/cert.p12 -P "$CSC_KEY_PASSWORD" -A -t cert -f pkcs12 -k ~/Library/Keychains/login.keychain-db 2>&1 && echo "✅ Certificate valid!" || echo "❌ Certificate invalid!"
            rm -f /tmp/cert.p12
          else
            echo "❌ CSC_LINK is empty!"
          fi
